/*
    Firefly Chess Engine
    Copyright (C) 2022  Ognyan Mirev

    This program is free software: you can redistribute it and/or modify
            it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
            but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/

#ifdef NNTEST_ENABLE
#include <engine/neural/lc0_network.h>
#include <chess/board.h>
#include <external/LeelaUtils/policy_map.h>
#include <engine/neural/utils/inverted_policy_map.h>
#include <engine/neural/utils/policy_map_to_flattened.h>
#include <sstream>
#include <string>
#include <utils/utils.h>

using namespace std;

static auto device = torch::Device(torch::DeviceType::CUDA);
static lc0::LC0Network network("../external/LeelaUtils/384x30-2021_1106_1405_42_923.pb", device, false);

bool floats_equal(float a, float b)
{
    return abs(a-b) < 0.01f;
}
void encoding_tests()
{

}
bool policy_test(string fen, string expected, string expected_input = "", vector<string> history_moves = {},
                 vector<float> wdl = {0,0,0}, unsigned M = 0)
{
    bool passed = true;
    stringstream ss(expected);
    string line;

    unordered_map<string, float> expected_values;

    while (getline(ss,line, '\n'))
    {
        auto cpos = line.find(':');
        string move = line.substr(0, cpos);
        string move_value = line.substr(cpos+1);
        expected_values[move] = stof(move_value);
    }

    vector<InputPlane> expected_input_planes;


    ss = stringstream(expected_input);
    while (getline(ss,line, '\n'))
    {
        auto cpos = line.find(':');
        auto mask = stoull(line.substr(0, cpos));
        auto value = stof(line.substr(cpos+1));

        expected_input_planes.push_back({});
        expected_input_planes.back().mask = mask;
        expected_input_planes.back().value = value;
    }


    chess::board board;
    if (!board.from_fen(fen))
    {
        cout << "Invalid FEN." << endl;
        return false;
    }

    //if (board.flipped)
    //    board.flip_board();


    int transform;
    auto batch = torch::zeros({1, 112, 8, 8}).to(device, torch::Dtype::Float);
    PositionHistory vec;
    vec.push_back(board);

    for (auto& i : history_moves)
    {
        board.make_move(i);
        vec.push_back(board);
    }
    chess::movegen_result moves;
    board.generate_moves(moves);

    //reverse(vec.begin(), vec.end());

    for (auto& i : vec)
    {
        cout << i.print() << endl << endl;
    }

    auto planes = lczero_modified::EncodePositionForNN(network->input_format, vec, 8,
                                                       lczero_modified::FillEmptyHistory::NO, &transform);

    cout << "Transform: " << transform << endl;

    for (int i = 0; i < planes.size(); i++)
    {
        if (planes[i].mask != expected_input_planes[i].mask || planes[i].value != expected_input_planes[i].value)
        {
            cout << "Plane index: " << i << "   " << endl;
            print_bitboard_list({expected_input_planes[i].mask, planes[i].mask}, {"Expected mask: ", "Mask: "});
            cout << "Expected value: " << expected_input_planes[i].value << "   Value: " << planes[i].value << endl;
        }
    }

    lc0::input_planes_to_tensor(planes, batch, 0);
    auto output = network(batch);



    float policy_flattened[1858];
    float pol_sum = 0;

    for (int i = 0; i < 73*8*8; i++)
    {
        int j = lczero_modified::kConvPolicyMap[i];

        if (j >= 0)
        {
            policy_flattened[j] = output.policy[0][i].item<float>();
            pol_sum += policy_flattened[j];
        }
    }

    for (int i = 0; i < moves; i++)
    {
        auto uci_move = moves[i].to_uci_move();

        if (board.flipped)
        {
            //cout << uci_move << "  ";
            uci_move[1] = '9' - uci_move[1] + '0';
            uci_move[3] = '9' - uci_move[3] + '0';
            //cout << uci_move << endl;
        }

        auto expected_policy = expected_values[uci_move];

        if (uci_move.back() == 'n') uci_move.pop_back();
        auto flattened_policy_idx = policy_map_to_flattened[uci_move];
        auto flattened_policy = policy_flattened[flattened_policy_idx];

        //cout << board.flipped << endl;
        auto uncompressed_policy_idx = board.flipped ? moves[i].to_flipped_policy_index() : moves[i].to_policy_index();
        auto uncompressed_policy = output.policy[0][uncompressed_policy_idx].item<float>();



        if (!floats_equal(flattened_policy, uncompressed_policy) || !floats_equal(uncompressed_policy, expected_policy)) {
            passed = false;
            cout << fen << endl;
            cout << "Move: " << moves[i].to_uci_move() << "    Flattened Policy: " << flattened_policy << "  idx = " <<
            flattened_policy_idx
                 << "    Uncompressed policy: " << uncompressed_policy << "  idx = " << uncompressed_policy_idx <<
                 "    Expected policy: " << expected_policy
                 << endl << endl;
            //throw std::logic_error("Policy mapping error.");
        }
    }

    if (passed)
    cout << fen << "   PASSED!" << endl;
    else
        cout << fen << "   FAILED!" << endl;

    return passed;
}

int main0()
{
    //region Promotions
    policy_test("8/PKP5/8/8/8/5n2/5kpp/8 w - - 0 1", "a7a8q: 1.5799\n"
                                                     "a7a8r: -0.876025\n"
                                                     "a7a8b: -1.59091\n"
                                                     "a7a8n: -1.50038\n"
                                                     "b7a6: -0.391218\n"
                                                     "b7b6: -0.437546\n"
                                                     "b7c6: -0.481766\n"
                                                     "b7a8: -0.380151\n"
                                                     "b7b8: -0.204849\n"
                                                     "b7c8: -1.26261\n"
                                                     "c7c8q: 1.54454\n"
                                                     "c7c8r: -0.820556\n"
                                                     "c7c8b: -1.71077\n"
                                                     "c7c8n: -2.32134",


                                                     "1407374883553280: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "562949953421312: 1\n"
                                                     "49152: 1\n"
                                                     "2097152: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "8192: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "0: 1\n"
                                                     "18446744073709551615: 0\n"
                                                     "0: 1\n"
                                                     "18446744073709551615: 1"
                                                     );
    //endregion

    // region Starting board
    policy_test("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1", "b1a3: -2.15555\n"
                                                                            "b1c3: -0.142954\n"
                                                                            "g1f3: 1.06192\n"
                                                                            "g1h3: -2.08865\n"
                                                                            "a2a3: -0.358695\n"
                                                                            "a2a4: -0.866065\n"
                                                                            "b2b3: 0.0695756\n"
                                                                            "b2b4: -1.5355\n"
                                                                            "c2c3: -0.299032\n"
                                                                            "c2c4: 0.960559\n"
                                                                            "d2d3: -0.380996\n"
                                                                            "d2d4: 1.44254\n"
                                                                            "e2e3: 0.406761\n"
                                                                            "e2e4: 0.822428\n"
                                                                            "f2f3: -2.3519\n"
                                                                            "f2f4: -1.47633\n"
                                                                            "g2g3: 0.801902\n"
                                                                            "g2g4: -2.70125\n"
                                                                            "h2h3: -0.178619\n"
                                                                            "h2h4: -1.71832",

                                                                            "65280: 1\n"
                                                                            "66: 1\n"
                                                                            "36: 1\n"
                                                                            "129: 1\n"
                                                                            "8: 1\n"
                                                                            "16: 1\n"
                                                                            "71776119061217280: 1\n"
                                                                            "4755801206503243776: 1\n"
                                                                            "2594073385365405696: 1\n"
                                                                            "9295429630892703744: 1\n"
                                                                            "576460752303423488: 1\n"
                                                                            "1152921504606846976: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "0: 1\n"
                                                                            "18446744073709551615: 1\n"
                                                                            "18446744073709551615: 1\n"
                                                                            "18446744073709551615: 1\n"
                                                                            "18446744073709551615: 1\n"
                                                                            "0: 1\n"
                                                                            "18446744073709551615: 0\n"
                                                                            "0: 1\n"
                                                                            "18446744073709551615: 1");
    //endregion

    //region Random mid-game
    policy_test("r1bqk2r/ppp4p/2n1p2n/1B1pP1p1/1b1P1B2/2P2N1P/PP1NQPP1/R4RK1 w Qkq - 0 1", "a1b1: -0.854442\n"
                                                                                           "a1c1: -0.882974\n"
                                                                                           "a1d1: -1.07522\n"
                                                                                           "a1e1: -1.16736\n"
                                                                                           "f1b1: -0.446982\n"
                                                                                           "f1c1: -0.28984\n"
                                                                                           "f1d1: -0.660609\n"
                                                                                           "f1e1: -0.714608\n"
                                                                                           "g1h1: -0.876603\n"
                                                                                           "g1h2: -0.938276\n"
                                                                                           "a2a3: 0.0499224\n"
                                                                                           "a2a4: -0.317919\n"
                                                                                           "b2b3: -2.13403\n"
                                                                                           "d2b1: -1.35927\n"
                                                                                           "d2b3: -0.680056\n"
                                                                                           "d2c4: -2.03006\n"
                                                                                           "d2e4: -1.72059\n"
                                                                                           "e2e1: -0.988217\n"
                                                                                           "e2e3: -1.39807\n"
                                                                                           "e2e4: -1.59205\n"
                                                                                           "e2d1: -0.683892\n"
                                                                                           "e2d3: -0.874784\n"
                                                                                           "e2c4: -1.4047\n"
                                                                                           "g2g3: -1.77584\n"
                                                                                           "g2g4: -1.36174\n"
                                                                                           "c3c4: -1.88982\n"
                                                                                           "c3b4: 2.62692\n"
                                                                                           "f3e1: -1.55252\n"
                                                                                           "f3h2: -1.50568\n"
                                                                                           "f3h4: -1.90948\n"
                                                                                           "f3g5: 1.50162\n"
                                                                                           "h3h4: -1.63766\n"
                                                                                           "f4h2: 0.157484\n"
                                                                                           "f4e3: 1.111\n"
                                                                                           "f4g3: -0.542066\n"
                                                                                           "f4g5: 3.1123\n"
                                                                                           "b5d3: -0.592286\n"
                                                                                           "b5a4: -1.00451\n"
                                                                                           "b5c4: -1.28677\n"
                                                                                           "b5a6: -0.44639\n"
                                                                                           "b5c6: -0.0505297",

                                                                                           "68862370560: 1\n"
                                                                                           "2099200: 1\n"
                                                                                           "9126805504: 1\n"
                                                                                           "33: 1\n"
                                                                                           "4096: 1\n"
                                                                                           "64: 1\n"
                                                                                           "38017023279628288: 1\n"
                                                                                           "145135534866432: 1\n"
                                                                                           "288230376185266176: 1\n"
                                                                                           "9295429630892703744: 1\n"
                                                                                           "576460752303423488: 1\n"
                                                                                           "1152921504606846976: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "0: 1\n"
                                                                                           "18446744073709551615: 1\n"
                                                                                           "0: 1\n"
                                                                                           "18446744073709551615: 1\n"
                                                                                           "18446744073709551615: 1\n"
                                                                                           "0: 1\n"
                                                                                           "18446744073709551615: 0\n"
                                                                                           "0: 1\n"
                                                                                           "18446744073709551615: 1");

    //endregion

    //region Random mid-game

    policy_test("r1n1kbnr/pPppppPp/2P1bP2/1P2q3/1P5Q/R3N3/5PBP/1NB1K2R w - - 0 1", "b1d2: -1.47327\n"
                                                                                   "b1c3: -1.66438\n"
                                                                                   "c1b2: -1.45479\n"
                                                                                   "c1d2: -1.89345\n"
                                                                                   "e1d1: -1.78196\n"
                                                                                   "e1f1: -1.7454\n"
                                                                                   "e1d2: -1.71465\n"
                                                                                   "e1e2: -1.81349\n"
                                                                                   "h1f1: -1.64093\n"
                                                                                   "h1g1: -1.27477\n"
                                                                                   "f2f3: -2.18359\n"
                                                                                   "f2f4: -0.941914\n"
                                                                                   "g2f1: -1.85534\n"
                                                                                   "g2f3: -1.93586\n"
                                                                                   "g2h3: -1.95278\n"
                                                                                   "g2e4: -1.82942\n"
                                                                                   "g2d5: -1.78364\n"
                                                                                   "h2h3: -2.02323\n"
                                                                                   "a3a1: -1.90192\n"
                                                                                   "a3a2: -1.89959\n"
                                                                                   "a3b3: -1.73024\n"
                                                                                   "a3c3: -1.56006\n"
                                                                                   "a3d3: -1.27445\n"
                                                                                   "a3a4: -2.03357\n"
                                                                                   "a3a5: -1.20044\n"
                                                                                   "a3a6: -1.4988\n"
                                                                                   "a3a7: -1.45307\n"
                                                                                   "h4h3: -1.4758\n"
                                                                                   "h4c4: -0.947241\n"
                                                                                   "h4d4: -1.20708\n"
                                                                                   "h4e4: -1.14906\n"
                                                                                   "h4f4: -1.0759\n"
                                                                                   "h4g4: -1.51749\n"
                                                                                   "h4h5: -1.69161\n"
                                                                                   "h4h6: -1.68719\n"
                                                                                   "h4h7: -0.929958\n"
                                                                                   "h4g3: -1.34202\n"
                                                                                   "h4g5: -1.45449\n"
                                                                                   "b5b6: -1.30926\n"
                                                                                   "c6d7: 0.144278\n"
                                                                                   "f6e7: -1.83105\n"
                                                                                   "b7b8q: -1.75714\n"
                                                                                   "b7b8r: -1.76378\n"
                                                                                   "b7b8b: -2.01923\n"
                                                                                   "b7b8n: -2.14139\n"
                                                                                   "b7a8q: 2.94781\n"
                                                                                   "b7a8r: 1.65961\n"
                                                                                   "b7a8b: 0.240313\n"
                                                                                   "b7a8n: -1.4385\n"
                                                                                   "b7c8q: 0.335037\n"
                                                                                   "b7c8r: -0.242235\n"
                                                                                   "b7c8b: -0.468194\n"
                                                                                   "b7c8n: -2.33844\n"
                                                                                   "g7f8q: 0.636351\n"
                                                                                   "g7f8r: 0.0690053\n"
                                                                                   "g7f8b: -0.122857\n"
                                                                                   "g7f8n: -1.73495\n"
                                                                                   "g7h8q: 2.43083\n"
                                                                                   "g7h8r: 1.50243\n"
                                                                                   "g7h8b: 0.444653\n"
                                                                                   "g7h8n: -0.0708245",


                                                                                   "18616939505033216: 1\n"
                                                                                    "1048578: 1\n"
                                                                                    "16388: 1\n"
                                                                                    "65664: 1\n"
                                                                                    "2147483648: 1\n"
                                                                                    "16: 1\n"
                                                                                    "53198770598313984: 1\n"
                                                                                    "4899916394579099648: 1\n"
                                                                                    "2305860601399738368: 1\n"
                                                                                    "9295429630892703744: 1\n"
                                                                                    "68719476736: 1\n"
                                                                                    "1152921504606846976: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "0: 1\n"
                                                                                    "18446744073709551615: 0\n"
                                                                                    "0: 1\n"
                                                                                    "18446744073709551615: 1");

    //endregion

    //region Single en passant
    policy_test("rnbqkbnr/1pp1pppp/p7/3pP3/8/8/PPPP1PPP/RNBQKBNR w KQkq d6 0 3",

        "b1a3: -2.07373\n"
                "b1c3: -0.783568\n"
                "d1e2: -0.51747\n"
                "d1f3: -0.544785\n"
                "d1g4: -0.62824\n"
                "d1h5: -0.711377\n"
                "e1e2: -1.01857\n"
                "f1e2: 0.25819\n"
                "f1d3: -0.493999\n"
                "f1c4: -0.175936\n"
                "f1b5: -0.275307\n"
                "f1a6: -1.65173\n"
                "g1e2: -0.46129\n"
                "g1f3: 0.901672\n"
                "g1h3: -2.08692\n"
                "a2a3: -0.745475\n"
                "a2a4: -1.31147\n"
                "b2b3: -0.45674\n"
                "b2b4: -1.95576\n"
                "c2c3: -0.294945\n"
                "c2c4: 0.0132984\n"
                "d2d3: -0.667097\n"
                "d2d4: 1.92082\n"
                "f2f3: -2.28679\n"
                "f2f4: -1.45486\n"
                "g2g3: 0.294906\n"
                "g2g4: -2.59146\n"
                "h2h3: -0.427643\n"
                "h2h4: -1.53757\n"
                "e5e6: -1.5989\n"
                "e5d6: -0.510943",

    "68719537920: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "69243978142187520: 1\n"
                "4755801206503243776: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "0: 1\n"
                "18446744073709551615: 0\n"
                "0: 1\n"
                "18446744073709551615: 1");
    //endregion

    //region All capturing promotions white

    policy_test("rrrrrrrr/PPPPPPPP/8/8/4K3/8/4k3/8 w - - 0 1",
                "e4d4: -0.380861\n"
                "e4f4: -0.405534\n"
                "e4d5: -0.35283\n"
                "e4e5: -0.21055\n"
                "e4f5: -0.261432\n"
                "a7b8q: 1.30653\n"
                "a7b8r: 0.585559\n"
                "a7b8b: 0.0656237\n"
                "a7b8n: -0.760544\n"
                "b7a8q: 1.13585\n"
                "b7a8r: 0.514171\n"
                "b7a8b: 0.0735188\n"
                "b7a8n: -0.60583\n"
                "b7c8q: 1.09187\n"
                "b7c8r: 0.321612\n"
                "b7c8b: -0.10822\n"
                "b7c8n: -0.896998\n"
                "c7b8q: 1.32874\n"
                "c7b8r: 0.543402\n"
                "c7b8b: -0.00739674\n"
                "c7b8n: -0.375525\n"
                "c7d8q: 0.903418\n"
                "c7d8r: 0.228845\n"
                "c7d8b: -0.13684\n"
                "c7d8n: -0.569194\n"
                "d7c8q: 1.15174\n"
                "d7c8r: 0.370489\n"
                "d7c8b: -0.0817519\n"
                "d7c8n: -0.370405\n"
                "d7e8q: 1.27778\n"
                "d7e8r: 0.505843\n"
                "d7e8b: -0.104977\n"
                "d7e8n: -0.508226\n"
                "f7e8q: 1.35761\n"
                "f7e8r: 0.576527\n"
                "f7e8b: -0.0889859\n"
                "f7e8n: -0.432418\n"
                "f7g8q: 1.51846\n"
                "f7g8r: 0.77886\n"
                "f7g8b: -0.0804673\n"
                "f7g8n: -0.790474\n"
                "g7f8q: 1.43835\n"
                "g7f8r: 0.689881\n"
                "g7f8b: 0.040309\n"
                "g7f8n: -0.293648\n"
                "g7h8q: 0.846734\n"
                "g7h8r: 0.176232\n"
                "g7h8b: -0.270408\n"
                "g7h8n: -0.572302\n"
                "h7g8q: 1.50937\n"
                "h7g8r: 0.83523\n"
                "h7g8b: 0.0819912\n"
                "h7g8n: 0.044015",



                "71776119061217280: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "268435456: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18374686479671623680: 1\n"
                "0: 1\n"
                "4096: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18446744073709551615: 0\n"
                "0: 1\n"
                "18446744073709551615: 1");
    //endregion

    //region All pushing promotions white

    policy_test("8/PPPPPPPP/8/4K3/8/8/3k4/8 w - - 0 1",
                "e5d4: 0.058342\n"
                "e5e4: 0.0980155\n"
                "e5f4: -0.0122133\n"
                "e5d5: 0.00714855\n"
                "e5f5: -0.023415\n"
                "e5d6: -0.0761298\n"
                "e5e6: -0.0419997\n"
                "e5f6: -0.113011\n"
                "a7a8q: 0.318624\n"
                "a7a8r: 0.2051\n"
                "a7a8b: -0.0946553\n"
                "a7a8n: -0.24774\n"
                "b7b8q: 0.45097\n"
                "b7b8r: 0.334703\n"
                "b7b8b: -0.0564577\n"
                "b7b8n: -0.0932764\n"
                "c7c8q: 0.484216\n"
                "c7c8r: 0.392893\n"
                "c7c8b: 0.0360207\n"
                "c7c8n: -0.137957\n"
                "d7d8q: 0.476621\n"
                "d7d8r: 0.505741\n"
                "d7d8b: 0.0880055\n"
                "d7d8n: -0.136066\n"
                "e7e8q: 0.378267\n"
                "e7e8r: 0.373\n"
                "e7e8b: 0.0483384\n"
                "e7e8n: -0.0599564\n"
                "f7f8q: 0.419021\n"
                "f7f8r: 0.413478\n"
                "f7f8b: 0.0889125\n"
                "f7f8n: -0.0970897\n"
                "g7g8q: 0.491054\n"
                "g7g8r: 0.441184\n"
                "g7g8b: 0.0449656\n"
                "g7g8n: -0.161518\n"
                "h7h8q: 0.325791\n"
                "h7h8r: 0.286725\n"
                "h7h8b: -0.137365\n"
                "h7h8n: -0.180556",

                "71776119061217280: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "68719476736: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "2048: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18446744073709551615: 0\n"
                "0: 1\n"
                "18446744073709551615: 1");
    //endregion

    //region All capturing promotions black

    policy_test("8/8/8/4K3/8/4k3/pppppppp/RRRRRRRR b - - 0 1",

                "e6d6: -0.259722\n"
                "e6f6: 0.345015\n"
                "a7b8q: 1.6417\n"
                "a7b8r: 0.665796\n"
                "a7b8b: -0.272413\n"
                "a7b8n: -1.47522\n"
                "b7a8q: 1.37344\n"
                "b7a8r: 0.508653\n"
                "b7a8b: -0.0223408\n"
                "b7a8n: -1.26531\n"
                "b7c8q: 1.19935\n"
                "b7c8r: 0.258741\n"
                "b7c8b: -0.407717\n"
                "b7c8n: -1.68501\n"
                "c7b8q: 1.64376\n"
                "c7b8r: 0.610483\n"
                "c7b8b: -0.300636\n"
                "c7b8n: -1.13515\n"
                "c7d8q: 0.842685\n"
                "c7d8r: 0.101874\n"
                "c7d8b: -0.33418\n"
                "c7d8n: -1.08504\n"
                "d7c8q: 1.24319\n"
                "d7c8r: 0.327496\n"
                "d7c8b: -0.307516\n"
                "d7c8n: -0.863824\n"
                "d7e8q: 1.50107\n"
                "d7e8r: 0.520696\n"
                "d7e8b: -0.278904\n"
                "d7e8n: -0.961655\n"
                "f7e8q: 1.65828\n"
                "f7e8r: 0.53271\n"
                "f7e8b: -0.309546\n"
                "f7e8n: -0.939692\n"
                "f7g8q: 2.01062\n"
                "f7g8r: 0.852246\n"
                "f7g8b: -0.362497\n"
                "f7g8n: -1.48512\n"
                "g7f8q: 1.79959\n"
                "g7f8r: 0.642282\n"
                "g7f8b: -0.185726\n"
                "g7f8n: -0.781303\n"
                "g7h8q: 1.04716\n"
                "g7h8r: 0.136077\n"
                "g7h8b: -0.430514\n"
                "g7h8n: -1.28232\n"
                "h7g8q: 1.96716\n"
                "h7g8r: 0.943569\n"
                "h7g8b: -0.135854\n"
                "h7g8n: -0.399123",

                "71776119061217280: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "17592186044416: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18374686479671623680: 1\n"
                "0: 1\n"
                "268435456: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 0\n"
                "0: 1\n"
                "18446744073709551615: 1");
    //endregion
    //region All pushing promotions black

    policy_test("8/8/8/4K3/8/4k3/pppppppp/8 b - - 0 1",
                "e6d6: -0.0185571\n"
                "e6f6: -0.0349256\n"
                "a7a8q: 0.37227\n"
                "a7a8r: 0.235442\n"
                "a7a8b: -0.104686\n"
                "a7a8n: -0.261755\n"
                "b7b8q: 0.437413\n"
                "b7b8r: 0.270261\n"
                "b7b8b: -0.0914078\n"
                "b7b8n: -0.0762328\n"
                "c7c8q: 0.430425\n"
                "c7c8r: 0.317077\n"
                "c7c8b: 0.0314899\n"
                "c7c8n: -0.0890072\n"
                "d7d8q: 0.309742\n"
                "d7d8r: 0.343292\n"
                "d7d8b: 0.0810358\n"
                "d7d8n: -0.0152111\n"
                "e7e8q: 0.329161\n"
                "e7e8r: 0.398704\n"
                "e7e8b: 0.117185\n"
                "e7e8n: 0.0156432\n"
                "f7f8q: 0.340079\n"
                "f7f8r: 0.391174\n"
                "f7f8b: 0.11229\n"
                "f7f8n: -0.0135598\n"
                "g7g8q: 0.494062\n"
                "g7g8r: 0.527225\n"
                "g7g8b: 0.159211\n"
                "g7g8n: -0.0518688\n"
                "h7h8q: 0.291637\n"
                "h7h8r: 0.323121\n"
                "h7h8b: -0.0861904\n"
                "h7h8n: -0.132426",


                "71776119061217280: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "17592186044416: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "268435456: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 0\n"
                "0: 1\n"
                "18446744073709551615: 1");
    //endregion


    //region History planes test starting board white
    policy_test("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
                "b1a3: -1.26747\n"
                "b1c3: -0.430126\n"
                "g1f3: -0.227731\n"
                "g1h3: -1.69868\n"
                "a2a3: -2.3195\n"
                "a2a4: -2.33716\n"
                "b2b3: -2.37063\n"
                "b2b4: -2.46128\n"
                "c2c3: -1.81703\n"
                "c2c4: -1.94127\n"
                "d2d3: 0.218817\n"
                "d2d4: -1.75915\n"
                "e2e3: -2.19442\n"
                "e2e4: -1.61841\n"
                "f2f3: -1.77998\n"
                "f2f4: -0.600645\n"
                "g2g3: -2.29491\n"
                "g2g4: -2.50985\n"
                "h2h3: -2.42607\n"
                "h2h4: -2.45447",

                "805359360: 1\n"
                "262208: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "57985150872453120: 1\n"
                "144150372447944704: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "805359360: 1\n"
                "262208: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "58265526337536000: 1\n"
                "144150372447944704: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "805359360: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "58265526337536000: 1\n"
                "144150372447944704: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "805359360: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "58265526337536000: 1\n"
                "4755801206503243776: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "268496640: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "58265526337536000: 1\n"
                "4755801206503243776: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "268496640: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "67272588153323520: 1\n"
                "4755801206503243776: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "65280: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "67272588153323520: 1\n"
                "4755801206503243776: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "65280: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "71776119061217280: 1\n"
                "4755801206503243776: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 0\n"
                "0: 1\n"
                "18446744073709551615: 1",


                {"e2e4","e7e5","f2f4","f7f5","g1f3","b8c6","a2a3"});


    //endregion



    //region History planes test starting board black

    policy_test("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR b KQkq - 0 1",
                "b1a3: -2.14309\n"
                "b1c3: 0.00542208\n"
                "d1e2: -0.974923\n"
                "e1e2: -2.50491\n"
                "f1e2: -0.608327\n"
                "f1d3: -1.61542\n"
                "f1c4: -1.60791\n"
                "f1b5: -2.46525\n"
                "f1a6: -2.47507\n"
                "h1g1: -2.29291\n"
                "h1h2: -2.23238\n"
                "a2a3: -0.65402\n"
                "a2a4: -1.44837\n"
                "b2b3: -1.82698\n"
                "b2b4: -2.46135\n"
                "c2c3: -0.542375\n"
                "c2c4: -1.31566\n"
                "d2d3: -0.467952\n"
                "d2d4: 3.52734\n"
                "g2g3: -1.00126\n"
                "g2g4: -2.16992\n"
                "f3g1: -2.11722\n"
                "f3h2: -2.15449\n"
                "f3d4: -2.62156\n"
                "f3h4: -2.38657\n"
                "f3e5: -2.47665\n"
                "f3g5: -2.47114\n"
                "h3h4: -1.93841\n"
                "e4e5: -1.9623",

                "276852480: 1\n"
                "2097154: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "67009736154808320: 1\n"
                "4611690416473899008: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "276852480: 1\n"
                "2097154: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "71495743596134400: 1\n"
                "4611690416473899008: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "268496640: 1\n"
                "2097154: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "71495743596134400: 1\n"
                "4611690416473899008: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "268496640: 1\n"
                "2097154: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "71776119061217280: 1\n"
                "4611690416473899008: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "268496640: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "71776119061217280: 1\n"
                "4611690416473899008: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "268496640: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "71776119061217280: 1\n"
                "4755801206503243776: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "65280: 1\n"
                "66: 1\n"
                "36: 1\n"
                "129: 1\n"
                "8: 1\n"
                "16: 1\n"
                "71776119061217280: 1\n"
                "4755801206503243776: 1\n"
                "2594073385365405696: 1\n"
                "9295429630892703744: 1\n"
                "576460752303423488: 1\n"
                "1152921504606846976: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 1\n"
                "18446744073709551615: 0\n"
                "0: 1\n"
                "18446744073709551615: 1",


                {"e7e5", "b1c3", "g8f6", "a2a3", "h7h6", "e2e3"});


    //endregion


    //region ???

    policy_test("rrrrrrrr/PPPPPPPP/8/5QK1/1kq5/8/pppppppp/RRRRRRRR w - - 0 1",

                "b1a1: -0.991475\n"
                "b1b2: 1.4916\n"
                "b1b3: -0.141308\n"
                "b1b4: 0.933057\n"
                "c1d1: -0.0672553\n"
                "c1c2: -0.164329\n"
                "e1d1: 2.08761\n"
                "e1e2: -1.47006\n"
                "e1e3: -1.18807\n"
                "e1e4: 0.623728\n"
                "e1e5: -1.04764\n"
                "e1e6: -0.760978\n"
                "e1e7: -0.576588\n"
                "e1e8: 0.364253\n"
                "f1g1: -1.42721\n"
                "f1f2: -1.41619\n"
                "h1g1: -1.27156\n"
                "h1h2: -1.96537\n"
                "h1h3: -1.13689\n"
                "h1h4: 0.978079\n"
                "h1h5: -1.58082\n"
                "h1h6: -1.37218\n"
                "f5f2: -1.61567\n"
                "f5f3: -1.89786\n"
                "f5f4: -1.71732\n"
                "f5a5: -1.94238\n"
                "f5b5: 0.744904\n"
                "f5c5: 0.189804\n"
                "f5d5: -1.91614\n"
                "f5e5: -1.74431\n"
                "f5f6: -1.79454\n"
                "f5c2: 0.73872\n"
                "f5d3: -1.73598\n"
                "f5h3: -1.95689\n"
                "f5e4: -1.75104\n"
                "f5g4: -1.88497\n"
                "f5e6: -1.91291\n"
                "f5g6: -1.83941\n"
                "g5f6: -1.34607\n"
                "g5g6: -1.63153\n"
                "g5h6: -1.38374\n"
                "b7a8q: 1.58817\n"
                "b7a8r: 0.0545331\n"
                "b7a8b: -0.401102\n"
                "b7a8n: -0.0357391\n"
                "d7d8q: 1.27313\n"
                "d7d8r: -1.04403\n"
                "d7d8b: -1.5204\n"
                "d7d8n: -1.4657\n"
                "d7e8q: 2.32244\n"
                "d7e8r: 0.794877\n"
                "d7e8b: -0.25853\n"
                "d7e8n: 1.08106\n"
                "f7e8q: 2.24528\n"
                "f7e8r: 0.716919\n"
                "f7e8b: -0.396501\n"
                "f7e8n: -1.94775\n"
                "f7g8q: 0.678436\n"
                "f7g8r: -0.385001\n"
                "f7g8b: -0.741477\n"
                "f7g8n: -2.14688\n"
                "h7g8q: 0.628092\n"
                "h7g8r: -0.243885\n"
                "h7g8b: -0.377847\n"
                "h7g8n: -0.655785\n"
                "b8a6: 0.873317\n"
                "b8c6: 2.59789\n"
                "c8d8: -1.701\n"
                "c8e8: 1.69422",

                "66991044457136128: 1\n"
                "144115188075855872: 1\n"
                "0: 1\n"
                "182: 1\n"
                "288230513590665216: 1\n"
                "274877906944: 1\n"
                "27904: 1\n"
                "0: 1\n"
                "64: 1\n"
                "17365880163140632577: 1\n"
                "67108872: 1\n"
                "33554432: 1\n"
                "0: 1\n"
                "66991044457136128: 1\n"
                "144115188075855872: 1\n"
                "0: 1\n"
                "183: 1\n"
                "288230513590665216: 1\n"
                "274877906944: 1\n"
                "28416: 1\n"
                "0: 1\n"
                "64: 1\n"
                "17365880163140632576: 1\n"
                "67108872: 1\n"
                "33554432: 1\n"
                "0: 1\n"
                "66991044457136128: 1\n"
                "144115188075855872: 1\n"
                "0: 1\n"
                "183: 1\n"
                "576460889742376960: 1\n"
                "274877906944: 1\n"
                "28416: 1\n"
                "0: 1\n"
                "64: 1\n"
                "17654110539292344320: 1\n"
                "67108872: 1\n"
                "33554432: 1\n"
                "0: 1\n"
                "66991044457136128: 1\n"
                "144115188075855872: 1\n"
                "0: 1\n"
                "247: 1\n"
                "576460889742376960: 1\n"
                "274877906944: 1\n"
                "61184: 1\n"
                "0: 1\n"
                "0: 1\n"
                "17654110539292344320: 1\n"
                "67108872: 1\n"
                "33554432: 1\n"
                "0: 1\n"
                "67272519433846784: 1\n"
                "0: 1\n"
                "0: 1\n"
                "247: 1\n"
                "576460889742376960: 1\n"
                "274877906944: 1\n"
                "61184: 1\n"
                "0: 1\n"
                "0: 1\n"
                "17798225727368200192: 1\n"
                "67108872: 1\n"
                "33554432: 1\n"
                "0: 1\n"
                "67272519433846784: 1\n"
                "0: 1\n"
                "0: 1\n"
                "255: 1\n"
                "576460889742376960: 1\n"
                "274877906944: 1\n"
                "65280: 1\n"
                "0: 1\n"
                "0: 1\n"
                "17798225727368200192: 1\n"
                "67108864: 1\n"
                "33554432: 1\n"
                "0: 1\n"
                "71776119061217280: 1\n"
                "0: 1\n"
                "0: 1\n"
                "255: 1\n"
                "137438953472: 1\n"
                "274877906944: 1\n"
                "65280: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18374686479671623680: 1\n"
                "67108864: 1\n"
                "33554432: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "0: 1\n"
                "18446744073709551615: 0\n"
                "0: 1\n"
                "18446744073709551615: 1",
                {"e7d8q", "e2d1q", "a7b8n", "h2g1b", "d8c8", "b2a1r"});

    //endregion

}
void all_tests()
{

}



bool remap_policy(uint64_t key, uint64_t shift)
{
    uint16_t final_mapping[32000] = {0};
    int maximal_index = 0;
    for (auto& i : inverted_policy_map)
    {
        auto uci_move = i.first;
        int srcx = uci_move[0] - 'a';
        int srcy = uci_move[1] - '1';

        int dstx = uci_move[2] - 'a';
        int dsty = uci_move[3] - '1';

        auto src = get_index(srcx, srcy);
        auto dst = get_index(dstx, dsty);

        int promotion = 0;


        if (uci_move.size() > 4)
        {
            switch (tolower(uci_move[4]))
            {
                case 'q':
                    promotion = QUEENS;
                    break;
                case 'r':
                    promotion = ROOKS;
                    break;
                case 'b':
                    promotion = BISHOPS;
                    break;
                case 'n':
                    promotion = KNIGHTS;
                    break;
                default:
                    throw std::invalid_argument(string("Invalid promotion: ") + uci_move[4]);
            }
        }


        uint64_t final_idx = src | (dst << 6) | (promotion << 12);

        //final_idx *= key;
        //final_idx >>= shift;

        if (final_mapping[final_idx]) return false;
        final_mapping[final_idx] = i.second;

        if (final_idx > maximal_index)
            maximal_index = final_idx;
    }

    auto len = maximal_index + 1;
    cout << "uint16_t policy_map[" << len << "] = {\n";
    for (int i = 0; i < len; i++)
    {
        cout << final_mapping[i] << ',' << endl;
    }
    cout << "};\n" << endl;
    cout << "Key: " << key << "\nShift: " << shift << "  max idx = " << maximal_index << endl;

    exit(0);
    return true;
}
#endif